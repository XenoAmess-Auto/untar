name: Build Debian Package

on:
  push:
    branches: [master, main]
    tags:
      - "v*"
  pull_request:
    branches: [master, main]

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-deb:
    name: Build .deb Package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config liblzma-dev dpkg-dev fakeroot

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: ./rust

      - name: Build release binary
        working-directory: ./rust
        run: cargo build --release --target x86_64-unknown-linux-gnu

      - name: Get version from Cargo.toml
        id: get_version
        run: |
          VERSION=$(grep '^version' rust/Cargo.toml | head -1 | sed 's/.*= *"\([^"]*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"

      - name: Create deb package structure
        run: |
          mkdir -p debian/DEBIAN
          mkdir -p debian/usr/bin
          mkdir -p debian/usr/share/doc/untar
          mkdir -p debian/usr/share/man/man1

          # Copy binary
          cp rust/target/x86_64-unknown-linux-gnu/release/untar debian/usr/bin/
          chmod 755 debian/usr/bin/untar

          # Create control file
          cat > debian/DEBIAN/control << EOF
          Package: untar
          Version: ${{ steps.get_version.outputs.version }}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: XenoAmess-bot <xenoamess.bot@gmail.com>
          Description: Fast command-line tool for extracting tar archives
           A lightweight, fast Linux command-line tool for extracting
           tar archives with support for multiple compression formats
           including .tar, .tar.gz, .tgz, .tar.xz, .tar.bz2, and .zip.
          Depends: libc6, liblzma5, libbz2-1.0, zlib1g
          EOF

          # Create copyright file
          cat > debian/usr/share/doc/untar/copyright << 'EOF'
          Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
          Upstream-Name: untar
          Source: https://github.com/XenoAmess-bot/untar

          Files: *
          Copyright: 2024 XenoAmess
          License: Apache-2.0
           Licensed under the Apache License, Version 2.0 (the "License");
           you may not use this file except in compliance with the License.
           You may obtain a copy of the License at
           .
               http://www.apache.org/licenses/LICENSE-2.0
           .
           Unless required by applicable law or agreed to in writing, software
           distributed under the License is distributed on an "AS IS" BASIS,
           WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
           See the License for the specific language governing permissions and
           limitations under the License.
          EOF

          chmod 644 debian/usr/share/doc/untar/copyright

          # Build .deb package
          dpkg-deb --build debian untar_${{ steps.get_version.outputs.version }}_amd64.deb

      - name: Upload deb artifact
        uses: actions/upload-artifact@v6
        with:
          name: untar-deb-package
          path: untar_${{ steps.get_version.outputs.version }}_amd64.deb

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: untar_${{ steps.get_version.outputs.version }}_amd64.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
